"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const relationshipPopulationPromise_1 = __importDefault(require("./relationshipPopulationPromise"));
const accessPromise = async ({ data, fullData, originalDoc, field, operation, overrideAccess, req, id, relationshipPopulations, depth, currentDepth, hook, payload, }) => {
    const resultingData = data;
    let accessOperation;
    if (hook === 'afterRead') {
        accessOperation = 'read';
    }
    else if (hook === 'beforeValidate') {
        if (operation === 'update')
            accessOperation = 'update';
        if (operation === 'create')
            accessOperation = 'create';
    }
    if (field.access && field.access[accessOperation]) {
        const result = overrideAccess ? true : await field.access[accessOperation]({ req, id, siblingData: data, data: fullData });
        if (!result && accessOperation === 'update' && originalDoc[field.name] !== undefined) {
            resultingData[field.name] = originalDoc[field.name];
        }
        else if (!result) {
            delete resultingData[field.name];
        }
    }
    if ((field.type === 'relationship' || field.type === 'upload') && hook === 'afterRead') {
        relationshipPopulations.push(relationshipPopulationPromise_1.default({
            data,
            field,
            depth,
            currentDepth,
            req,
            overrideAccess,
            payload,
        }));
    }
};
exports.default = accessPromise;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjZXNzUHJvbWlzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9maWVsZHMvYWNjZXNzUHJvbWlzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUVBLG9HQUE0RTtBQW9CNUUsTUFBTSxhQUFhLEdBQUcsS0FBSyxFQUFFLEVBQzNCLElBQUksRUFDSixRQUFRLEVBQ1IsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBQ1QsY0FBYyxFQUNkLEdBQUcsRUFDSCxFQUFFLEVBQ0YsdUJBQXVCLEVBQ3ZCLEtBQUssRUFDTCxZQUFZLEVBQ1osSUFBSSxFQUNKLE9BQU8sR0FDRyxFQUFpQixFQUFFO0lBQzdCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQztJQUUzQixJQUFJLGVBQWUsQ0FBQztJQUVwQixJQUFJLElBQUksS0FBSyxXQUFXLEVBQUU7UUFDeEIsZUFBZSxHQUFHLE1BQU0sQ0FBQztLQUMxQjtTQUFNLElBQUksSUFBSSxLQUFLLGdCQUFnQixFQUFFO1FBQ3BDLElBQUksU0FBUyxLQUFLLFFBQVE7WUFBRSxlQUFlLEdBQUcsUUFBUSxDQUFDO1FBQ3ZELElBQUksU0FBUyxLQUFLLFFBQVE7WUFBRSxlQUFlLEdBQUcsUUFBUSxDQUFDO0tBQ3hEO0lBRUQsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEVBQUU7UUFDakQsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUUzSCxJQUFJLENBQUMsTUFBTSxJQUFJLGVBQWUsS0FBSyxRQUFRLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLEVBQUU7WUFDcEYsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JEO2FBQU0sSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNsQixPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbEM7S0FDRjtJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLGNBQWMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxJQUFJLElBQUksS0FBSyxXQUFXLEVBQUU7UUFDdEYsdUJBQXVCLENBQUMsSUFBSSxDQUFDLHVDQUE2QixDQUFDO1lBQ3pELElBQUk7WUFDSixLQUFLO1lBQ0wsS0FBSztZQUNMLFlBQVk7WUFDWixHQUFHO1lBQ0gsY0FBYztZQUNkLE9BQU87U0FDUixDQUFDLENBQUMsQ0FBQztLQUNMO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsa0JBQWUsYUFBYSxDQUFDIn0=