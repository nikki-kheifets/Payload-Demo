"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose_1 = __importDefault(require("mongoose"));
const logger_1 = __importDefault(require("../utilities/logger"));
const testCredentials_1 = require("./testCredentials");
const logger = logger_1.default();
const connectMongoose = async (url, options, local) => {
    let urlToConnect = url;
    let successfulConnectionMessage = 'Connected to Mongo server successfully!';
    const connectionOptions = {
        ...options,
        useNewUrlParser: true,
        useUnifiedTopology: true,
        useCreateIndex: true,
        autoIndex: true,
        useFindAndModify: false,
    };
    if (process.env.NODE_ENV === 'test') {
        if (local) {
            urlToConnect = `${testCredentials_1.connection.url}:${testCredentials_1.connection.port}/${testCredentials_1.connection.name}`;
        }
        else {
            connectionOptions.dbName = 'payloadmemory';
            // eslint-disable-next-line global-require, @typescript-eslint/no-var-requires
            const { MongoMemoryServer } = require('mongodb-memory-server');
            const mongo = await MongoMemoryServer.create({
                instance: {
                    dbName: testCredentials_1.connection.name,
                    port: testCredentials_1.connection.port,
                },
            });
            urlToConnect = mongo.getUri();
            successfulConnectionMessage = 'Connected to in-memory Mongo server successfully!';
        }
    }
    try {
        await mongoose_1.default.connect(urlToConnect, connectionOptions);
        logger.info(successfulConnectionMessage);
    }
    catch (err) {
        logger.error(`Error: cannot connect to MongoDB. Details: ${err.message}`, err);
        process.exit(1);
    }
};
exports.default = connectMongoose;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb25nb29zZS9jb25uZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsd0RBQXVEO0FBQ3ZELGlFQUF5QztBQUN6Qyx1REFBK0M7QUFFL0MsTUFBTSxNQUFNLEdBQUcsZ0JBQU0sRUFBRSxDQUFDO0FBRXhCLE1BQU0sZUFBZSxHQUFHLEtBQUssRUFBRSxHQUFXLEVBQUUsT0FBMEIsRUFBRSxLQUFjLEVBQWlCLEVBQUU7SUFDdkcsSUFBSSxZQUFZLEdBQUcsR0FBRyxDQUFDO0lBQ3ZCLElBQUksMkJBQTJCLEdBQUcseUNBQXlDLENBQUM7SUFDNUUsTUFBTSxpQkFBaUIsR0FBRztRQUN4QixHQUFHLE9BQU87UUFDVixlQUFlLEVBQUUsSUFBSTtRQUNyQixrQkFBa0IsRUFBRSxJQUFJO1FBQ3hCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLFNBQVMsRUFBRSxJQUFJO1FBQ2YsZ0JBQWdCLEVBQUUsS0FBSztLQUN4QixDQUFDO0lBRUYsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLEVBQUU7UUFDbkMsSUFBSSxLQUFLLEVBQUU7WUFDVCxZQUFZLEdBQUcsR0FBRyw0QkFBVSxDQUFDLEdBQUcsSUFBSSw0QkFBVSxDQUFDLElBQUksSUFBSSw0QkFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQzFFO2FBQU07WUFDTCxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDO1lBQzNDLDhFQUE4RTtZQUM5RSxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUMvRCxNQUFNLEtBQUssR0FBRyxNQUFNLGlCQUFpQixDQUFDLE1BQU0sQ0FBQztnQkFDM0MsUUFBUSxFQUFFO29CQUNSLE1BQU0sRUFBRSw0QkFBVSxDQUFDLElBQUk7b0JBQ3ZCLElBQUksRUFBRSw0QkFBVSxDQUFDLElBQUk7aUJBQ3RCO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsWUFBWSxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUM5QiwyQkFBMkIsR0FBRyxtREFBbUQsQ0FBQztTQUNuRjtLQUNGO0lBR0QsSUFBSTtRQUNGLE1BQU0sa0JBQVEsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDeEQsTUFBTSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQzFDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixNQUFNLENBQUMsS0FBSyxDQUFDLDhDQUE4QyxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0UsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNqQjtBQUNILENBQUMsQ0FBQztBQUVGLGtCQUFlLGVBQWUsQ0FBQyJ9